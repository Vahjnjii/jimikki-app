<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>Jimikki</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<style>
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
body{background:#F4F6FB;font-family:'Inter',system-ui,sans-serif;color:#1A1D2E;min-height:100vh}
input,select,button{font-family:inherit}
input[type=date]{color-scheme:light}
::-webkit-scrollbar{width:4px}::-webkit-scrollbar-thumb{background:#E8ECF4;border-radius:4px}
</style>
</head>
<body><div id="root"></div>
<script>
const {useState,useEffect,useRef}=React;
const r=React.createElement;

/* ‚îÄ‚îÄ constants ‚îÄ‚îÄ */
const uid=()=>Date.now().toString(36)+Math.random().toString(36).slice(2,6);
const fmt=n=>`‚Çπ${(+n||0).toLocaleString('en-IN',{minimumFractionDigits:2,maximumFractionDigits:2})}`;
const fmtS=n=>{const v=+n||0;if(v>=100000)return`‚Çπ${(v/100000).toFixed(1)}L`;if(v>=1000)return`‚Çπ${(v/1000).toFixed(1)}K`;return`‚Çπ${v.toFixed(0)}`;};
const todayStr=()=>new Date().toISOString().slice(0,10);
const PALETTE=['#6366F1','#F43F5E','#F97316','#22C55E','#06B6D4','#A855F7','#FBBF24','#EC4899'];
const OE='__exp_other__', OI='__inc_other__';
const C={bg:'#F4F6FB',card:'#FFF',border:'#E8ECF4',text:'#1A1D2E',sub:'#64748B',muted:'#A0AEC0',
  accent:'#4F46E5',green:'#10B981',red:'#F43F5E',blue:'#3B82F6',
  accentBg:'#EEF2FF',greenBg:'#ECFDF5',redBg:'#FFF1F2'};

const DEF_EXP=[
  {id:'b1',name:'Food & Dining',color:'#F97316',deleted:false},
  {id:'b2',name:'Shopping',color:'#A855F7',deleted:false},
  {id:'b3',name:'Transport',color:'#06B6D4',deleted:false},
  {id:'b4',name:'Health',color:'#22C55E',deleted:false},
  {id:'b5',name:'Entertainment',color:'#F43F5E',deleted:false},
  {id:'b6',name:'Utilities',color:'#6366F1',deleted:false},
  {id:OE,name:'Other',color:'#94A3B8',deleted:false,fixed:true},
];
const DEF_INC=[
  {id:'i1',name:'Salary',color:'#10B981',deleted:false},
  {id:'i2',name:'Freelance',color:'#6366F1',deleted:false},
  {id:'i3',name:'Business',color:'#F97316',deleted:false},
  {id:'i4',name:'Investment',color:'#06B6D4',deleted:false},
  {id:'i5',name:'Gift',color:'#EC4899',deleted:false},
  {id:OI,name:'Other',color:'#94A3B8',deleted:false,fixed:true},
];

/* ‚îÄ‚îÄ filter helpers ‚îÄ‚îÄ */
function applyFilter(txns,f){
  if(!f||f.type==='all')return txns;
  const now=new Date();
  if(f.type==='week'){const w=new Date(now);w.setDate(w.getDate()-6);return txns.filter(t=>new Date(t.date)>=w);}
  if(f.type==='month'){const d=new Date(now.getFullYear(),now.getMonth(),1);return txns.filter(t=>new Date(t.date)>=d);}
  if(f.type==='quarter'){const d=new Date(now);d.setMonth(d.getMonth()-2);d.setDate(1);return txns.filter(t=>new Date(t.date)>=d);}
  if(f.type==='year')return txns.filter(t=>t.date.startsWith(String(now.getFullYear())));
  if(f.type==='custom'&&f.from&&f.to){const a=new Date(f.from),b=new Date(f.to);b.setHours(23,59,59);return txns.filter(t=>{const d=new Date(t.date);return d>=a&&d<=b;});}
  if(f.type==='custom'&&f.from)return txns.filter(t=>new Date(t.date)>=new Date(f.from));
  if(f.type==='yearmonth'&&f.ym)return txns.filter(t=>t.date.slice(0,7)===f.ym);
  return txns;
}
function filterLabel(f){
  if(!f||f.type==='all')return'All Time';
  if(f.type==='week')return'This Week';
  if(f.type==='month')return'This Month';
  if(f.type==='quarter')return'Last 3 Mo';
  if(f.type==='year')return'This Year';
  if(f.type==='yearmonth'&&f.ym){const[y,m]=f.ym.split('-');return new Date(+y,+m-1,1).toLocaleDateString('en',{month:'long',year:'numeric'});}
  if(f.type==='custom'){
    const a=f.from?new Date(f.from).toLocaleDateString('en',{day:'numeric',month:'short'}):'';
    const b=f.to?new Date(f.to).toLocaleDateString('en',{day:'numeric',month:'short'}):'';
    if(a&&b)return`${a}‚Äì${b}`;if(a)return`From ${a}`;return'Custom';
  }
  return'‚Äî';
}

/* ‚îÄ‚îÄ data builders ‚îÄ‚îÄ */
function buildBalanceData(txns,holders,fH,gran){
  const actH=holders.filter(h=>!h.deleted);
  const curBal=fH?actH.filter(h=>h.id===fH).reduce((s,h)=>s+h.balance,0):actH.reduce((s,h)=>s+h.balance,0);
  const base=txns.filter(t=>t.type!=='swap'&&(!fH||t.holderId===fH));
  const now=new Date();
  function balAt(ds){
    const after=base.filter(t=>t.date>ds);
    return Math.max(0,curBal-after.filter(t=>t.type==='income').reduce((s,t)=>s+t.amount,0)+after.filter(t=>t.type==='spending').reduce((s,t)=>s+t.amount,0));
  }
  if(gran==='week')return Array.from({length:7},(_,i)=>{const d=new Date(now);d.setDate(d.getDate()-(6-i));const k=d.toISOString().slice(0,10);return{name:d.toLocaleDateString('en',{weekday:'short'}),Value:balAt(k),date:k,gran:'week'};});
  if(gran==='month')return Array.from({length:12},(_,i)=>{const mo=new Date(now.getFullYear(),now.getMonth()-11+i,1);const last=new Date(mo.getFullYear(),mo.getMonth()+1,0);const k=last.toISOString().slice(0,10);return{name:mo.toLocaleDateString('en',{month:'short'}),Value:balAt(k),date:k,gran:'month'};});
  if(gran==='year'){const yr=now.getFullYear();return Array.from({length:12},(_,i)=>{const last=new Date(yr,i+1,0);const k=last.toISOString().slice(0,10);return{name:last.toLocaleDateString('en',{month:'short'}),Value:balAt(k),date:k,gran:'year'};});}
  return Array.from({length:5},(_,i)=>{const yr=now.getFullYear()-4+i;return{name:String(yr),Value:balAt(`${yr}-12-31`),date:`${yr}-12-31`,gran:'5year',year:yr};});
}
function buildNetData(txns,fH){
  const base=txns.filter(t=>t.type!=='swap'&&(!fH||t.holderId===fH));
  const now=new Date();
  return Array.from({length:12},(_,i)=>{
    const d=new Date(now.getFullYear(),now.getMonth()-11+i,1);
    const k=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
    const mo=base.filter(t=>t.date.slice(0,7)===k);
    const inc=mo.filter(t=>t.type==='income').reduce((s,t)=>s+t.amount,0);
    const spd=mo.filter(t=>t.type==='spending').reduce((s,t)=>s+t.amount,0);
    return{name:d.toLocaleDateString('en',{month:'short'}),Value:Math.max(0,inc-spd),inc,spd};
  });
}
function makeExploreFilter(pt){
  if(pt.gran==='week')return{type:'custom',from:pt.date,to:pt.date};
  if(pt.gran==='month'||pt.gran==='year')return{type:'yearmonth',ym:pt.date.slice(0,7)};
  if(pt.gran==='5year')return{type:'custom',from:`${pt.year}-01-01`,to:`${pt.year}-12-31`};
  return{type:'all'};
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê CHARTS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function BalanceAreaChart({data,height=200,onExplore}){
  const [tip,setTip]=useState(null);
  const svgRef=useRef(null);
  if(!data||!data.length)return null;
  const vals=data.map(d=>d.Value);
  const max=Math.max(...vals,1),min=Math.min(...vals,0),range=max-min||1;
  const W=460,H=height,pL=52,pB=24,pT=16,pR=8,cw=W-pL-pR,ch=H-pB-pT,n=data.length;
  const xOf=i=>pL+(i/(n-1||1))*cw, yOf=v=>pT+ch-((v-min)/range)*ch;
  const pts=data.map((d,i)=>[xOf(i),yOf(d.Value)]);
  function smoothPath(){if(pts.length<2)return`M${pts[0]}`;let d=`M${pts[0][0]},${pts[0][1]}`;for(let i=0;i<pts.length-1;i++){const mx=(pts[i][0]+pts[i+1][0])/2;d+=` C${mx},${pts[i][1]} ${mx},${pts[i+1][1]} ${pts[i+1][0]},${pts[i+1][1]}`;}return d;}
  const lp=smoothPath(), ap=`${lp} L${pts[n-1][0]},${H-pB} L${pts[0][0]},${H-pB} Z`;
  const up=vals[vals.length-1]>=vals[0], lc=up?C.accent:C.red, gid='g'+Math.random().toString(36).slice(2,5);
  function handleDot(ev,d,i){ev.stopPropagation();const rc=svgRef.current.getBoundingClientRect();setTip({x:rc.left+(xOf(i)/W)*rc.width,y:rc.top+(yOf(d.Value)/H)*rc.height,d});}
  return r('div',{style:{position:'relative',userSelect:'none'}},
    tip&&r('div',{style:{position:'fixed',inset:0,zIndex:90},onClick:()=>setTip(null)}),
    r('svg',{ref:svgRef,viewBox:`0 0 ${W} ${H}`,style:{width:'100%',height,display:'block'},onClick:()=>setTip(null)},
      r('defs',null,r('linearGradient',{id:gid,x1:'0',y1:'0',x2:'0',y2:'1'},r('stop',{offset:'0%',stopColor:lc,stopOpacity:0.22}),r('stop',{offset:'90%',stopColor:lc,stopOpacity:0.02}))),
      ...Array.from({length:5},(_,i)=>{const v=min+(range/4)*i,y=yOf(v);return r('g',{key:i},r('line',{x1:pL,y1:y,x2:W-pR,y2:y,stroke:C.border,strokeDasharray:'3 3'}),r('text',{x:pL-4,y:y+3,textAnchor:'end',fontSize:9,fill:C.muted},fmtS(v)));}),
      r('path',{d:ap,fill:`url(#${gid})`}),
      r('path',{d:lp,fill:'none',stroke:lc,strokeWidth:2.5,strokeLinecap:'round',strokeLinejoin:'round'}),
      ...data.map((d,i)=>r('g',{key:i},
        r('circle',{cx:xOf(i),cy:yOf(d.Value),r:tip&&tip.d===d?6:4,fill:'white',stroke:lc,strokeWidth:2.5,style:{cursor:'pointer'},onClick:ev=>handleDot(ev,d,i)}),
        r('text',{x:xOf(i),y:H-6,textAnchor:'middle',fontSize:9,fill:C.muted},d.name)
      ))
    ),
    tip&&r('div',{style:{position:'fixed',left:tip.x,top:tip.y,transform:'translate(-50%,-115%)',background:'white',border:`1px solid ${C.border}`,borderRadius:'16px',padding:'12px 14px',boxShadow:'0 6px 28px rgba(0,0,0,0.14)',zIndex:999,minWidth:'180px'},onClick:e=>e.stopPropagation()},
      r('div',{style:{fontSize:'0.65rem',fontWeight:700,color:C.muted,letterSpacing:'0.08em',marginBottom:'4px'}},'BALANCE ¬∑ '+tip.d.name),
      r('div',{style:{fontSize:'1.15rem',fontWeight:800,color:C.accent,marginBottom:'10px'}},fmt(tip.d.Value)),
      r('button',{onClick:()=>{onExplore(makeExploreFilter(tip.d));setTip(null);},style:{width:'100%',display:'flex',alignItems:'center',justifyContent:'center',gap:'6px',padding:'7px 10px',borderRadius:'10px',border:`1.5px solid ${C.accent}`,background:C.accentBg,color:C.accent,cursor:'pointer',fontWeight:700,fontSize:'0.75rem'}},
        '‚ú¶ Explore in Analytics'
      )
    )
  );
}

function NetBarChart({data,height=190}){
  const [tip,setTip]=useState(null);
  const svgRef=useRef(null);
  if(!data||!data.length)return null;
  const max=Math.max(...data.map(d=>d.Value),1);
  const W=460,H=height,pL=44,pB=24,pT=10,pR=8,cw=W-pL-pR,ch=H-pB-pT;
  const bw=Math.min(28,cw/data.length*0.5),gap=cw/data.length;
  const xOf=i=>pL+gap*i+gap/2, yOf=v=>pT+ch-Math.max(0,(v/max)*ch);
  function showTip(ev,d,i){const rc=svgRef.current.getBoundingClientRect();setTip({x:rc.left+(xOf(i)/W)*rc.width,y:rc.top+(yOf(d.Value)/H)*rc.height,d});}
  return r('div',{style:{position:'relative',userSelect:'none'}},
    r('svg',{ref:svgRef,viewBox:`0 0 ${W} ${H}`,style:{width:'100%',height},onClick:()=>setTip(null)},
      ...Array.from({length:5},(_,i)=>{const v=(max/4)*i,y=yOf(v);return r('g',{key:i},r('line',{x1:pL,y1:y,x2:W-pR,y2:y,stroke:C.border,strokeDasharray:'3 3'}),r('text',{x:pL-4,y:y+3,textAnchor:'end',fontSize:9,fill:C.muted},fmtS(v)));}),
      ...data.map((d,i)=>r('g',{key:i,style:{cursor:'pointer'},onClick:ev=>{ev.stopPropagation();showTip(ev,d,i);}},
        r('rect',{x:xOf(i)-bw/2,y:yOf(d.Value),width:bw,height:Math.max(2,(d.Value/max)*ch),fill:tip&&tip.d===d?C.accent:'#818CF8',rx:4,opacity:tip&&tip.d===d?1:0.85}),
        r('text',{x:xOf(i),y:H-6,textAnchor:'middle',fontSize:9,fill:C.muted},d.name)
      ))
    ),
    tip&&r('div',{style:{position:'fixed',left:tip.x,top:tip.y,transform:'translate(-50%,-110%)',background:'white',border:`1px solid ${C.border}`,borderRadius:'14px',padding:'10px 14px',boxShadow:'0 4px 24px rgba(0,0,0,0.12)',zIndex:999,whiteSpace:'nowrap'},onClick:e=>e.stopPropagation()},
      r('div',{style:{fontWeight:700,color:C.sub,fontSize:'0.68rem',marginBottom:'6px'}},tip.d.name),
      r('div',{style:{display:'flex',flexDirection:'column',gap:'3px'}},
        r('div',{style:{display:'flex',justifyContent:'space-between',gap:'24px'}},r('span',{style:{color:C.green,fontWeight:600}},'Income'),r('span',{style:{fontWeight:700}},fmt(tip.d.inc))),
        r('div',{style:{display:'flex',justifyContent:'space-between',gap:'24px'}},r('span',{style:{color:C.red,fontWeight:600}},'Spending'),r('span',{style:{fontWeight:700}},fmt(tip.d.spd))),
        r('div',{style:{height:'1px',background:C.border,margin:'3px 0'}}),
        r('div',{style:{display:'flex',justifyContent:'space-between',gap:'24px'}},r('span',{style:{color:C.accent,fontWeight:700}},'Net'),r('span',{style:{fontWeight:800,color:C.accent}},fmt(tip.d.Value)))
      )
    )
  );
}

function DonutChart({data}){
  const [tip,setTip]=useState(null);
  if(!data||!data.length)return r('div',{style:{textAlign:'center',padding:'2rem',color:C.muted,fontSize:'0.8rem'}},'No data for this period');
  const total=data.reduce((s,d)=>s+d.total,0);
  const cx=90,cy=90,R=76,ri=48;let angle=-Math.PI/2;
  const slices=data.map(d=>{const sa=angle,sw=(d.total/total)*2*Math.PI;angle+=sw;const ea=angle;const x1=cx+R*Math.cos(sa),y1=cy+R*Math.sin(sa),x2=cx+R*Math.cos(ea),y2=cy+R*Math.sin(ea),ix1=cx+ri*Math.cos(sa),iy1=cy+ri*Math.sin(sa),ix2=cx+ri*Math.cos(ea),iy2=cy+ri*Math.sin(ea),lg=sw>Math.PI?1:0;return{...d,path:`M${ix1},${iy1}L${x1},${y1}A${R},${R} 0 ${lg} 1 ${x2},${y2}L${ix2},${iy2}A${ri},${ri} 0 ${lg} 0 ${ix1},${iy1}Z`};});
  return r('div',{style:{position:'relative',display:'flex',justifyContent:'center'}},
    r('svg',{viewBox:'0 0 180 180',style:{width:180,height:180},onMouseLeave:()=>setTip(null)},
      ...slices.map((s,i)=>r('path',{key:i,d:s.path,fill:s.color,stroke:'white',strokeWidth:2.5,style:{cursor:'pointer',opacity:tip&&tip.id!==s.id?.55:1},
        onMouseEnter:ev=>setTip({id:s.id,x:ev.clientX,y:ev.clientY,name:s.name,total:s.total,pct:((s.total/total)*100).toFixed(1)}),
        onTouchStart:ev=>setTip({id:s.id,x:ev.touches[0].clientX,y:ev.touches[0].clientY,name:s.name,total:s.total,pct:((s.total/total)*100).toFixed(1)})
      })),
      r('text',{x:cx,y:cy-6,textAnchor:'middle',fontSize:11,fill:C.muted,fontWeight:600},'Total'),
      r('text',{x:cx,y:cy+10,textAnchor:'middle',fontSize:12,fill:C.text,fontWeight:800},fmtS(total))
    ),
    tip&&r('div',{style:{position:'fixed',left:tip.x,top:tip.y,transform:'translate(-50%,-110%)',background:'white',border:`1px solid ${C.border}`,borderRadius:'14px',padding:'10px 14px',boxShadow:'0 4px 24px rgba(0,0,0,0.12)',zIndex:999,pointerEvents:'none'}},
      r('div',{style:{fontWeight:700,color:C.sub,fontSize:'0.68rem',marginBottom:'4px'}},tip.name),
      r('div',{style:{fontWeight:800,color:C.text}},fmt(tip.total)),
      r('div',{style:{fontSize:'0.68rem',color:C.muted,marginTop:'2px'}},`${tip.pct}% of total`)
    )
  );
}

/* ‚îÄ‚îÄ Bucket legend row ‚îÄ‚îÄ */
function BucketRow({b,total,grand}){
  const pct=grand>0?((total/grand)*100).toFixed(1):0;
  return r('div',{style:{marginBottom:'0.7rem'}},
    r('div',{style:{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:'4px'}},
      r('div',{style:{display:'flex',alignItems:'center',gap:'7px'}},r('div',{style:{width:'9px',height:'9px',borderRadius:'3px',background:b.color,flexShrink:0}}),r('span',{style:{fontSize:'0.82rem',fontWeight:600,color:C.text}},b.name)),
      r('div',null,r('span',{style:{fontSize:'0.82rem',fontWeight:700,color:C.text}},fmt(total)),r('span',{style:{fontSize:'0.65rem',color:C.muted,marginLeft:'5px'}},`${pct}%`))
    ),
    r('div',{style:{height:'5px',background:C.bg,borderRadius:'3px',overflow:'hidden'}},r('div',{style:{height:'100%',width:`${pct}%`,background:b.color,borderRadius:'3px'}}))
  );
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MODALS / PANELS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function DeleteConfirmModal({txn,bName,ibName,hName,onConfirm,onCancel}){
  const col=txn.type==='income'?C.green:txn.type==='swap'?C.blue:C.red;
  const lbl=txn.type==='income'?'Income':txn.type==='swap'?'Transfer':'Spending';
  const desc=txn.note||(txn.incBucketId?ibName(txn.incBucketId):txn.bucketId?bName(txn.bucketId):'Transaction');
  return r('div',{style:{position:'fixed',inset:0,zIndex:700,display:'flex',alignItems:'center',justifyContent:'center',padding:'1rem'}},
    r('div',{style:{position:'absolute',inset:0,background:'rgba(0,0,0,0.45)',backdropFilter:'blur(5px)'},onClick:onCancel}),
    r('div',{style:{position:'relative',background:'white',borderRadius:'24px',padding:'1.75rem 1.5rem',width:'100%',maxWidth:'360px',boxShadow:'0 12px 48px rgba(0,0,0,0.22)',textAlign:'center'}},
      r('div',{style:{width:'56px',height:'56px',borderRadius:'50%',background:C.redBg,display:'flex',alignItems:'center',justifyContent:'center',fontSize:'1.6rem',margin:'0 auto 1rem'}},'üóëÔ∏è'),
      r('div',{style:{fontWeight:800,fontSize:'1rem',color:C.text,marginBottom:'0.4rem'}},'Delete Transaction?'),
      r('div',{style:{fontSize:'0.78rem',color:C.sub,marginBottom:'1rem',lineHeight:1.6}},
        'This will reverse the ',r('span',{style:{color:col,fontWeight:700}},lbl.toLowerCase()),
        ' of ',r('span',{style:{fontWeight:700,color:C.text}},fmt(txn.amount)),` (${desc}) and move it to Recycle Bin.`
      ),
      r('div',{style:{background:C.bg,borderRadius:'12px',padding:'0.65rem',fontSize:'0.72rem',color:C.muted,marginBottom:'1.25rem'}},'üí° Restore anytime from Recycle Bin in Analytics ‚Üí Transactions'),
      r('div',{style:{display:'flex',gap:'0.65rem'}},
        r('button',{onClick:onCancel,style:{flex:1,padding:'0.75rem',borderRadius:'12px',border:`1.5px solid ${C.border}`,background:'white',color:C.sub,cursor:'pointer',fontWeight:700}},'Cancel'),
        r('button',{onClick:onConfirm,style:{flex:1,padding:'0.75rem',borderRadius:'12px',border:'none',background:C.red,color:'white',cursor:'pointer',fontWeight:700}},'Delete')
      )
    )
  );
}

function HomeFilterPanel({filter,onChange,onClose}){
  const now=new Date();
  const [type,setType]=useState(filter.type||'all');
  const [from,setFrom]=useState(filter.from||'');
  const [to,setTo]=useState(filter.to||'');
  const [ym,setYm]=useState(filter.ym||`${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`);
  const months=[];for(let i=0;i<24;i++){const d=new Date(now.getFullYear(),now.getMonth()-i,1);months.push({key:`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`,label:d.toLocaleDateString('en',{month:'long',year:'numeric'})});}
  function apply(){onChange(type==='custom'?{type,from,to}:type==='yearmonth'?{type,ym}:{type});onClose();}
  const pill=(t,l)=>r('button',{key:t,onClick:()=>setType(t),style:{padding:'6px 14px',borderRadius:'999px',border:`1px solid ${type===t?C.accent:C.border}`,background:type===t?C.accent:'white',color:type===t?'white':C.sub,cursor:'pointer',fontSize:'0.73rem',fontWeight:700}},l);
  return r('div',{style:{position:'fixed',inset:0,zIndex:400,display:'flex',alignItems:'flex-end',justifyContent:'center'}},
    r('div',{style:{position:'absolute',inset:0,background:'rgba(0,0,0,0.4)',backdropFilter:'blur(4px)'},onClick:onClose}),
    r('div',{style:{position:'relative',background:'white',borderRadius:'28px 28px 0 0',padding:'1.5rem 1.25rem 2.5rem',width:'100%',maxWidth:'480px',boxShadow:'0 -8px 40px rgba(0,0,0,0.15)'}},
      r('div',{style:{width:'36px',height:'4px',borderRadius:'2px',background:C.border,margin:'0 auto 1.25rem'}}),
      r('div',{style:{fontWeight:800,fontSize:'1rem',color:C.text,marginBottom:'1rem'}},'üóì Filter by Time'),
      r('div',{style:{display:'flex',gap:'6px',flexWrap:'wrap',marginBottom:'1rem'}},pill('all','All Time'),pill('week','This Week'),pill('month','This Month'),pill('quarter','Last 3 Mo'),pill('year','This Year'),pill('yearmonth','Specific Month'),pill('custom','Custom Range')),
      type==='yearmonth'&&r('select',{value:ym,onChange:ev=>setYm(ev.target.value),style:{width:'100%',background:C.bg,border:`1.5px solid ${C.border}`,borderRadius:'12px',padding:'0.6rem 0.85rem',color:C.text,fontSize:'0.9rem',outline:'none',marginBottom:'1rem'}},...months.map(m=>r('option',{key:m.key,value:m.key},m.label))),
      type==='custom'&&r('div',{style:{display:'grid',gridTemplateColumns:'1fr 1fr',gap:'0.6rem',marginBottom:'1rem'}},
        r('div',null,r('div',{style:{fontSize:'0.62rem',fontWeight:700,color:C.muted,marginBottom:'5px'}},'FROM'),r('input',{type:'date',value:from,onChange:ev=>setFrom(ev.target.value),style:{width:'100%',background:C.bg,border:`1.5px solid ${C.border}`,borderRadius:'12px',padding:'0.6rem 0.85rem',color:C.text,outline:'none'}})),
        r('div',null,r('div',{style:{fontSize:'0.62rem',fontWeight:700,color:C.muted,marginBottom:'5px'}},'TO'),r('input',{type:'date',value:to,onChange:ev=>setTo(ev.target.value),style:{width:'100%',background:C.bg,border:`1.5px solid ${C.border}`,borderRadius:'12px',padding:'0.6rem 0.85rem',color:C.text,outline:'none'}}))
      ),
      r('button',{onClick:apply,style:{width:'100%',padding:'0.85rem',borderRadius:'14px',border:'none',background:C.accent,color:'white',fontWeight:800,fontSize:'0.95rem',cursor:'pointer'}},'Apply Filter')
    )
  );
}

/* ‚îÄ‚îÄ Analytics Filter Modal ‚îÄ‚îÄ */
function AnalyticsFilterModal({timeFilter,holderFilter,bucketFilter,holders,actExpB,actIncB,onApply,onClose}){
  const now=new Date();
  const [type,setType]=useState(timeFilter.type||'month');
  const [from,setFrom]=useState(timeFilter.from||'');
  const [to,setTo]=useState(timeFilter.to||'');
  const [ym,setYm]=useState(timeFilter.ym||`${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`);
  const [hF,setHF]=useState(holderFilter);
  const [bF,setBF]=useState(bucketFilter);
  const months=[];for(let i=0;i<24;i++){const d=new Date(now.getFullYear(),now.getMonth()-i,1);months.push({key:`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`,label:d.toLocaleDateString('en',{month:'long',year:'numeric'})});}
  function apply(){onApply(type==='custom'?{type,from,to}:type==='yearmonth'?{type,ym}:{type},hF,bF);onClose();}
  function clear(){setType('month');setHF(null);setBF(null);}
  const tpill=(t,l)=>r('button',{key:t,onClick:()=>setType(t),style:{padding:'5px 12px',borderRadius:'999px',border:`1px solid ${type===t?C.accent:C.border}`,background:type===t?C.accent:'white',color:type===t?'white':C.sub,cursor:'pointer',fontSize:'0.7rem',fontWeight:700}},l);
  const hchip=(h)=>{const a=hF===h.id;return r('button',{key:h.id,onClick:()=>setHF(a?null:h.id),style:{padding:'4px 12px',borderRadius:'999px',border:`1px solid ${a?C.accent:C.border}`,background:a?C.accentBg:'white',color:a?C.accent:C.sub,cursor:'pointer',fontSize:'0.71rem',fontWeight:a?700:400}},h.name);};
  const bchip=(b)=>{const a=bF===b.id;return r('button',{key:b.id,onClick:()=>setBF(a?null:b.id),style:{display:'flex',alignItems:'center',gap:'5px',padding:'4px 12px',borderRadius:'999px',border:`1px solid ${a?C.accent:C.border}`,background:a?C.accentBg:'white',color:a?C.accent:C.sub,cursor:'pointer',fontSize:'0.71rem',fontWeight:a?700:400}},r('span',{style:{width:'7px',height:'7px',borderRadius:'50%',background:b.color,display:'inline-block'}}),b.name);};
  const sec=(label,children)=>r('div',{style:{marginBottom:'1rem'}},r('div',{style:{fontSize:'0.6rem',fontWeight:700,color:C.muted,letterSpacing:'0.1em',marginBottom:'0.45rem'}},label),children);
  return r('div',{style:{position:'fixed',inset:0,zIndex:500,display:'flex',alignItems:'flex-end',justifyContent:'center'}},
    r('div',{style:{position:'absolute',inset:0,background:'rgba(0,0,0,0.42)',backdropFilter:'blur(4px)'},onClick:onClose}),
    r('div',{style:{position:'relative',background:'white',borderRadius:'28px 28px 0 0',padding:'1.5rem 1.25rem 2.5rem',width:'100%',maxWidth:'480px',boxShadow:'0 -8px 40px rgba(0,0,0,0.18)',maxHeight:'88vh',overflowY:'auto'}},
      r('div',{style:{width:'36px',height:'4px',borderRadius:'2px',background:C.border,margin:'0 auto 1.1rem'}}),
      r('div',{style:{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:'1.1rem'}},
        r('div',{style:{fontWeight:800,fontSize:'1rem',color:C.text}},'‚öôÔ∏è Analytics Filter'),
        r('button',{onClick:clear,style:{fontSize:'0.72rem',color:C.accent,background:'none',border:'none',cursor:'pointer',fontWeight:700,padding:'4px 8px',borderRadius:'8px',background:C.accentBg}},'Clear All')
      ),
      sec('TIME PERIOD',r('div',null,
        r('div',{style:{display:'flex',gap:'6px',flexWrap:'wrap'}},tpill('all','All Time'),tpill('week','This Week'),tpill('month','This Month'),tpill('quarter','Last 3 Mo'),tpill('year','This Year'),tpill('yearmonth','Specific Month'),tpill('custom','Custom Range')),
        type==='yearmonth'&&r('select',{value:ym,onChange:ev=>setYm(ev.target.value),style:{marginTop:'0.5rem',width:'100%',background:C.bg,border:`1.5px solid ${C.border}`,borderRadius:'12px',padding:'0.6rem 0.85rem',color:C.text,fontSize:'0.88rem',outline:'none'}},...months.map(m=>r('option',{key:m.key,value:m.key},m.label))),
        type==='custom'&&r('div',{style:{display:'grid',gridTemplateColumns:'1fr 1fr',gap:'0.5rem',marginTop:'0.5rem'}},
          r('div',null,r('div',{style:{fontSize:'0.62rem',fontWeight:700,color:C.muted,marginBottom:'4px'}},'FROM'),r('input',{type:'date',value:from,onChange:ev=>setFrom(ev.target.value),style:{width:'100%',background:C.bg,border:`1.5px solid ${C.border}`,borderRadius:'12px',padding:'0.55rem 0.75rem',color:C.text,fontSize:'0.82rem',outline:'none'}})),
          r('div',null,r('div',{style:{fontSize:'0.62rem',fontWeight:700,color:C.muted,marginBottom:'4px'}},'TO'),r('input',{type:'date',value:to,onChange:ev=>setTo(ev.target.value),style:{width:'100%',background:C.bg,border:`1.5px solid ${C.border}`,borderRadius:'12px',padding:'0.55rem 0.75rem',color:C.text,fontSize:'0.82rem',outline:'none'}}))
        )
      )),
      holders.filter(h=>!h.deleted).length>0&&sec('HOLDER',r('div',{style:{display:'flex',gap:'6px',flexWrap:'wrap'}},
        r('button',{onClick:()=>setHF(null),style:{padding:'4px 12px',borderRadius:'999px',border:`1px solid ${!hF?C.accent:C.border}`,background:!hF?C.accentBg:'white',color:!hF?C.accent:C.sub,cursor:'pointer',fontSize:'0.71rem',fontWeight:!hF?700:400}},'All Holders'),
        ...holders.filter(h=>!h.deleted).map(hchip)
      )),
      sec('INCOME SOURCE',r('div',{style:{display:'flex',gap:'6px',flexWrap:'wrap'}},
        r('button',{onClick:()=>setBF(null),style:{padding:'4px 12px',borderRadius:'999px',border:`1px solid ${!bF||actExpB.some(b=>b.id===bF)?C.border:C.border}`,background:'white',color:C.muted,cursor:'pointer',fontSize:'0.71rem'}},!bF?'‚óè All':' All'),
        ...actIncB.map(bchip)
      )),
      sec('EXPENSE CATEGORY',r('div',{style:{display:'flex',gap:'6px',flexWrap:'wrap'}},...actExpB.map(bchip))),
      r('button',{onClick:apply,style:{width:'100%',padding:'0.85rem',borderRadius:'14px',border:'none',background:C.accent,color:'white',fontWeight:800,fontSize:'0.95rem',cursor:'pointer'}},'Apply Filter')
    )
  );
}

/* ‚îÄ‚îÄ atoms ‚îÄ‚îÄ */
function Card({children,style={}}){return r('div',{style:{background:C.card,borderRadius:'20px',padding:'1.25rem',boxShadow:'0 2px 12px rgba(0,0,0,0.05)',border:`1px solid ${C.border}`,...style}},children);}
function SL({children,req}){return r('div',{style:{fontSize:'0.62rem',fontWeight:700,color:C.muted,letterSpacing:'0.09em',marginBottom:'5px',display:'flex',gap:'3px'}},children,req&&r('span',{style:{color:C.red}},'*'));}
function FI({style={},...p}){return r('input',{...p,style:{width:'100%',background:C.bg,border:`1.5px solid ${C.border}`,borderRadius:'12px',padding:'0.6rem 0.85rem',color:C.text,fontSize:'0.9rem',outline:'none',boxSizing:'border-box',...style}});}
function FS({children,style={},...p}){return r('select',{...p,style:{width:'100%',background:C.bg,border:`1.5px solid ${C.border}`,borderRadius:'12px',padding:'0.6rem 0.85rem',color:C.text,fontSize:'0.88rem',outline:'none',boxSizing:'border-box',...style}},children);}
function GranPills({value,onChange}){return r('div',{style:{display:'flex',gap:'4px',flexWrap:'wrap'}},...[['week','Weekly'],['month','Monthly'],['year','Yearly'],['5year','5Y']].map(([v,l])=>r('button',{key:v,onClick:()=>onChange(v),style:{padding:'4px 10px',borderRadius:'999px',border:`1px solid ${value===v?C.accent:C.border}`,background:value===v?C.accent:'white',color:value===v?'white':C.sub,cursor:'pointer',fontSize:'0.68rem',fontWeight:700}},l)));}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   MAIN APP
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function Jimikki(){
  const [view,setView]=useState('home');
  const [sidebar,setSidebar]=useState(false);
  const [holders,setHolders]=useState([]);
  const [txns,setTxns]=useState([]);
  const [expBuckets,setExpBuckets]=useState(DEF_EXP);
  const [incBuckets,setIncBuckets]=useState(DEF_INC);
  const [loaded,setLoaded]=useState(false);
  const [userEmail,setUserEmail]=useState('');
  const [toast,setToast]=useState('');
  const [pendingDelId,setPendingDelId]=useState(null);

  // FAB state
  const [fabOpen,setFabOpen]=useState(false);
  const [fabMode,setFabMode]=useState(null);
  const [jAmt,setJAmt]=useState('');
  const [jNote,setJNote]=useState('');
  const [jExpB,setJExpB]=useState('');
  const [jIncB,setJIncB]=useState('');
  const [jFrom,setJFrom]=useState('');
  const [jTo,setJTo]=useState('');
  const [jDate,setJDate]=useState(todayStr());

  // Home
  const [hFilter,setHFilter]=useState({type:'month'});
  const [hFilterOpen,setHFilterOpen]=useState(false);
  const [hGran,setHGran]=useState('month');
  const [hHFilter,setHHFilter]=useState(null);

  // Analytics
  const [aFilter,setAFilter]=useState({type:'month'});
  const [aHFilter,setAHFilter]=useState(null);
  const [aBFilter,setABFilter]=useState(null);
  const [aFilterOpen,setAFilterOpen]=useState(false);
  const [aView,setAView]=useState('flow');

  // Sidebar forms
  const [nhName,setNhName]=useState('');const [nhBal,setNhBal]=useState('');
  const [nbExpName,setNbExpName]=useState('');const [nbExpColor,setNbExpColor]=useState(PALETTE[0]);
  const [nbIncName,setNbIncName]=useState('');const [nbIncColor,setNbIncColor]=useState(PALETTE[3]);

  const actH=holders.filter(x=>!x.deleted);
  const delH=holders.filter(x=>x.deleted);
  const actExpB=expBuckets.filter(b=>!b.deleted);
  const actIncB=incBuckets.filter(b=>!b.deleted);
  const actT=txns.filter(t=>!t.deleted).sort((a,b)=>b.date.localeCompare(a.date));
  const delT=txns.filter(t=>t.deleted);

  const hN=id=>holders.find(x=>x.id===id)?.name||'?';
  const bN=id=>expBuckets.find(x=>x.id===id)?.name||'(removed)';
  const bC=id=>expBuckets.find(x=>x.id===id)?.color||C.muted;
  const ibN=id=>incBuckets.find(x=>x.id===id)?.name||'(removed)';
  const ibC=id=>incBuckets.find(x=>x.id===id)?.color||C.muted;
  const wealth=fH=>(fH?actH.filter(x=>x.id===fH):actH).reduce((s,x)=>s+x.balance,0);

  useEffect(()=>{
    fetch('/api/data')
      .then(r=>{if(!r.ok)throw new Error();return r.json();})
      .then(d=>{
        setHolders(d.holders||[]);
        setTxns(d.transactions||[]);
        setExpBuckets(d.expBuckets||DEF_EXP);
        setIncBuckets(d.incBuckets||DEF_INC);
        if(d.email)setUserEmail(d.email);
      })
      .catch(()=>{})
      .finally(()=>setLoaded(true));
  },[]);
  useEffect(()=>{
    if(!loaded)return;
    fetch('/api/data',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({holders,transactions:txns,expBuckets,incBuckets})}).catch(()=>{});
  },[holders,txns,expBuckets,incBuckets,loaded]);

  const pop=msg=>{setToast(msg);setTimeout(()=>setToast(''),2800);};

  function getStats(list){
    const inc=list.filter(t=>t.type==='income').reduce((s,t)=>s+t.amount,0);
    const spd=list.filter(t=>t.type==='spending').reduce((s,t)=>s+t.amount,0);
    return{inc,spd,net:Math.max(0,inc-spd)};
  }

  function openFab(mode){setFabMode(mode);setJAmt('');setJNote('');setJExpB('');setJIncB('');setJDate(todayStr());setJFrom(actH.find(x=>x.isPrimary)?.id||actH[0]?.id||'');setJTo('');}

  function submitTxn(){
    const amt=parseFloat(jAmt);
    if(!amt||amt<=0)return pop('Enter a valid amount');
    const from=holders.find(x=>x.id===jFrom);
    if(!from)return pop('Select a holder');
    if(fabMode==='swap'){
      if(!jTo||jTo===jFrom)return pop('Select a different destination');
      if(!jNote.trim())return pop('Note is required for transfers');
      if(from.balance<amt)return pop('Insufficient balance');
      setTxns(ts=>[{id:uid(),type:'swap',amount:amt,note:jNote.trim(),holderId:jFrom,toHolderId:jTo,date:jDate,deleted:false},...ts]);
      setHolders(hs=>hs.map(x=>{if(x.id===jFrom)return{...x,balance:x.balance-amt};if(x.id===jTo)return{...x,balance:x.balance+amt};return x;}));
      setFabOpen(false);setFabMode(null);pop('Transfer recorded ‚úì');return;
    }
    if(fabMode==='income'){
      if(!jIncB)return pop('Select an income source');
      if(jIncB===OI&&amt>=1000&&!jNote.trim())return pop('Note required for "Other" when ‚â• ‚Çπ1,000');
      setTxns(ts=>[{id:uid(),type:'income',amount:amt,note:jNote.trim(),incBucketId:jIncB,holderId:jFrom,date:jDate,deleted:false},...ts]);
      setHolders(hs=>hs.map(x=>x.id===jFrom?{...x,balance:x.balance+amt}:x));
    } else {
      if(!jExpB)return pop('Select a spending category');
      if(jExpB===OE&&amt>=1000&&!jNote.trim())return pop('Note required for "Other" when ‚â• ‚Çπ1,000');
      if(from.balance<amt)return pop('Insufficient balance');
      setTxns(ts=>[{id:uid(),type:'spending',amount:amt,note:jNote.trim(),bucketId:jExpB,holderId:jFrom,date:jDate,deleted:false},...ts]);
      setHolders(hs=>hs.map(x=>x.id===jFrom?{...x,balance:x.balance-amt}:x));
    }
    setFabOpen(false);setFabMode(null);pop('Entry added ‚úì');
  }

  const isOther=(fabMode==='income'&&jIncB===OI)||(fabMode==='spending'&&jExpB===OE);
  const otherNeedsNote=isOther&&parseFloat(jAmt||0)>=1000;

  function confirmDel(){
    const t=txns.find(x=>x.id===pendingDelId);if(!t){setPendingDelId(null);return;}
    if(t.type==='income'){const x=holders.find(x=>x.id===t.holderId);if(x&&x.balance<t.amount){setPendingDelId(null);return pop('Cannot delete ‚Äî would cause negative balance');}}
    if(t.type==='swap'){const x=holders.find(x=>x.id===t.toHolderId);if(x&&x.balance<t.amount){setPendingDelId(null);return pop('Cannot delete ‚Äî would cause negative balance');}}
    setHolders(hs=>hs.map(x=>{
      if(t.type==='income'&&x.id===t.holderId)return{...x,balance:x.balance-t.amount};
      if(t.type==='spending'&&x.id===t.holderId)return{...x,balance:x.balance+t.amount};
      if(t.type==='swap'){if(x.id===t.holderId)return{...x,balance:x.balance+t.amount};if(x.id===t.toHolderId)return{...x,balance:x.balance-t.amount};}
      return x;
    }));
    setTxns(ts=>ts.map(x=>x.id===pendingDelId?{...x,deleted:true}:x));
    setPendingDelId(null);pop('Moved to Recycle Bin üóëÔ∏è');
  }

  function restTxn(id){
    const t=txns.find(x=>x.id===id);if(!t)return;
    setHolders(hs=>hs.map(x=>{if(t.type==='income'&&x.id===t.holderId)return{...x,balance:x.balance+t.amount};if(t.type==='spending'&&x.id===t.holderId)return{...x,balance:x.balance-t.amount};if(t.type==='swap'){if(x.id===t.holderId)return{...x,balance:x.balance-t.amount};if(x.id===t.toHolderId)return{...x,balance:x.balance+t.amount};}return x;}));
    setTxns(ts=>ts.map(x=>x.id===id?{...x,deleted:false}:x));pop('Restored ‚úì');
  }

  function addHolder(){if(!nhName.trim())return pop('Enter a name');const bal=Math.max(0,parseFloat(nhBal)||0);setHolders(hs=>[...hs,{id:uid(),name:nhName.trim(),balance:bal,isPrimary:hs.filter(x=>!x.deleted).length===0,deleted:false}]);setNhName('');setNhBal('');pop('Holder added ‚úì');}

  /* ‚îÄ‚îÄ Updated delete logic: zero balance ‚Üí archive directly; non-zero ‚Üí block ‚îÄ‚îÄ */
  function tryDelHolder(id){
    const h=holders.find(x=>x.id===id);
    if(!h)return;
    if(h.isPrimary)return pop("Can't remove the primary holder");
    if(h.balance>0)return pop(`"${h.name}" has ${fmt(h.balance)} ‚Äî clear balance first`);
    setHolders(hs=>hs.filter(x=>x.id!==id));
    pop(`"${h.name}" deleted ‚úì`);
  }

  function restHolder(id){setHolders(hs=>hs.map(x=>x.id===id?{...x,deleted:false}:x));pop('Restored ‚úì');}
  function setPrimary(id){setHolders(hs=>hs.map(x=>({...x,isPrimary:x.id===id})));pop('Primary set');}

  function addExpB(){if(!nbExpName.trim())return pop('Enter name');const fixed=expBuckets.find(b=>b.id===OE);setExpBuckets(bs=>[...bs.filter(b=>!b.fixed),{id:uid(),name:nbExpName.trim(),color:nbExpColor,deleted:false},fixed].filter(Boolean));setNbExpName('');pop('Expense bucket added ‚úì');}
  function delExpB(id){if(id===OE)return;setExpBuckets(bs=>bs.map(b=>b.id===id?{...b,deleted:true}:b));pop('Removed ‚Äî history preserved');}
  function addIncB(){if(!nbIncName.trim())return pop('Enter name');const fixed=incBuckets.find(b=>b.id===OI);setIncBuckets(bs=>[...bs.filter(b=>!b.fixed),{id:uid(),name:nbIncName.trim(),color:nbIncColor,deleted:false},fixed].filter(Boolean));setNbIncName('');pop('Income bucket added ‚úì');}
  function delIncB(id){if(id===OI)return;setIncBuckets(bs=>bs.map(b=>b.id===id?{...b,deleted:true}:b));pop('Removed ‚Äî history preserved');}

  function handleExplore(filter){setAFilter(filter);setAHFilter(null);setABFilter(null);setAView('txns');setView('analytics');}
  function handleAFilter(tf,hf,bf){setAFilter(tf);setAHFilter(hf);setABFilter(bf);}

  /* ‚îÄ‚îÄ computed for home ‚îÄ‚îÄ */
  const hFilteredT=applyFilter(actT.filter(t=>t.type!=='swap'&&(!hHFilter||t.holderId===hHFilter)),hFilter);
  const hStats=getStats(hFilteredT);
  const hBalData=buildBalanceData(actT,holders,hHFilter,hGran);

  /* ‚îÄ‚îÄ computed for analytics ‚îÄ‚îÄ */
  const aFilteredT=applyFilter(
    actT.filter(t=>{
      const hMatch=!aHFilter||t.holderId===aHFilter||(t.type==='swap'&&t.toHolderId===aHFilter);
      const bMatch=!aBFilter||t.bucketId===aBFilter||t.incBucketId===aBFilter;
      return hMatch&&bMatch;
    }),
    aFilter
  );
  const aStats=getStats(aFilteredT.filter(t=>t.type!=='swap'));

  const incStats=actIncB
    .map(b=>({...b,total:aFilteredT.filter(t=>t.type==='income'&&t.incBucketId===b.id).reduce((s,t)=>s+t.amount,0)}))
    .filter(b=>b.total>0).sort((a,b)=>b.total-a.total);
  const incTotal=incStats.reduce((s,b)=>s+b.total,0);

  const expStats=actExpB
    .map(b=>({...b,total:aFilteredT.filter(t=>t.type==='spending'&&t.bucketId===b.id).reduce((s,t)=>s+t.amount,0)}))
    .filter(b=>b.total>0).sort((a,b)=>b.total-a.total);
  const expTotal=expStats.reduce((s,b)=>s+b.total,0);

  const aBadge=()=>{const p=[filterLabel(aFilter)];if(aHFilter){const h=holders.find(x=>x.id===aHFilter);if(h)p.push(h.name);}if(aBFilter){const ib=incBuckets.find(x=>x.id===aBFilter),eb=expBuckets.find(x=>x.id===aBFilter);p.push(ib?.name||eb?.name||'');}return p.filter(Boolean).join(' ¬∑ ');};
  const aActiveCount=(aFilter.type!=='all'?1:0)+(aHFilter?1:0)+(aBFilter?1:0);

  const pendingTxn=pendingDelId?txns.find(x=>x.id===pendingDelId):null;

  /* TxnRow */
  function TxnRow({t,onDel,onRest}){
    const col=t.type==='income'?C.green:t.type==='swap'?C.blue:C.red;
    const bg=t.type==='income'?C.greenBg:t.type==='swap'?'#EFF6FF':C.redBg;
    const bLabel=t.type==='income'?ibN(t.incBucketId):t.type==='spending'?bN(t.bucketId):null;
    const bCol=t.type==='income'?ibC(t.incBucketId):t.type==='spending'?bC(t.bucketId):null;
    return r('div',{style:{display:'grid',gridTemplateColumns:'40px 1fr auto 34px',gap:'0.5rem',alignItems:'center',padding:'0.7rem 0',borderBottom:`1px solid ${C.border}`}},
      r('div',{style:{width:'40px',height:'40px',borderRadius:'12px',background:bg,display:'flex',alignItems:'center',justifyContent:'center',fontSize:'1.1rem',flexShrink:0}},t.type==='income'?'‚ÜôÔ∏è':t.type==='swap'?'‚ÜîÔ∏è':'‚ÜóÔ∏è'),
      r('div',{style:{minWidth:0}},
        r('div',{style:{fontSize:'0.85rem',fontWeight:600,color:C.text,overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap'}},t.note||bLabel||'Transfer'),
        r('div',{style:{fontSize:'0.68rem',color:C.sub,marginTop:'2px',display:'flex',gap:'5px',flexWrap:'wrap'}},
          r('span',null,t.date),
          bLabel&&r('span',{style:{color:bCol,fontWeight:600}},`¬∑ ${bLabel}`),
          t.toHolderId&&r('span',{style:{color:C.blue}},`¬∑ ${hN(t.holderId)} ‚Üí ${hN(t.toHolderId)}`),
          !t.toHolderId&&r('span',null,`¬∑ ${hN(t.holderId)}`)
        )
      ),
      r('span',{style:{fontSize:'0.88rem',fontWeight:700,color:col,whiteSpace:'nowrap'}},(t.type==='income'?'+':t.type==='spending'?'-':'')+fmt(t.amount)),
      onDel&&r('button',{onClick:onDel,style:{background:C.redBg,border:`1px solid ${C.red}22`,borderRadius:'8px',width:'28px',height:'28px',cursor:'pointer',color:C.red,fontSize:'1.1rem',display:'flex',alignItems:'center',justifyContent:'center',fontWeight:700,flexShrink:0,lineHeight:1}},'√ó'),
      onRest&&r('button',{onClick:onRest,style:{background:C.greenBg,color:C.green,border:'none',borderRadius:'7px',padding:'3px 7px',cursor:'pointer',fontSize:'0.65rem',fontWeight:700}},'‚Ü©')
    );
  }

  if(!loaded)return r('div',{style:{minHeight:'100vh',display:'flex',flexDirection:'column',alignItems:'center',justifyContent:'center',background:C.bg}},r('div',{style:{fontFamily:'cursive',fontSize:'2.5rem',color:C.accent}},'Jimikki'),r('div',{style:{fontSize:'0.8rem',color:C.sub}},'Loading‚Ä¶'));

  return r('div',{style:{minHeight:'100vh',background:C.bg,maxWidth:'480px',margin:'0 auto',fontFamily:'"Inter",system-ui,sans-serif',color:C.text}},

    toast&&r('div',{style:{position:'fixed',top:'1rem',left:'50%',transform:'translateX(-50%)',zIndex:2000,background:C.text,color:'white',padding:'0.55rem 1.25rem',borderRadius:'999px',fontSize:'0.78rem',whiteSpace:'nowrap',boxShadow:'0 4px 20px rgba(0,0,0,0.2)'}},toast),
    pendingTxn&&r(DeleteConfirmModal,{txn:pendingTxn,bName:bN,ibName:ibN,hName:hN,onConfirm:confirmDel,onCancel:()=>setPendingDelId(null)}),
    hFilterOpen&&r(HomeFilterPanel,{filter:hFilter,onChange:setHFilter,onClose:()=>setHFilterOpen(false)}),
    aFilterOpen&&r(AnalyticsFilterModal,{timeFilter:aFilter,holderFilter:aHFilter,bucketFilter:aBFilter,holders,actExpB,actIncB,onApply:handleAFilter,onClose:()=>setAFilterOpen(false)}),

    /* FAB overlay */
    fabOpen&&r('div',{style:{position:'fixed',inset:0,zIndex:300,display:'flex',flexDirection:'column',justifyContent:'flex-end'}},
      r('div',{style:{position:'absolute',inset:0,background:'rgba(15,18,40,0.5)',backdropFilter:'blur(6px)'},onClick:()=>{setFabOpen(false);setFabMode(null);}}),
      r('div',{style:{position:'relative',background:'white',borderRadius:'28px 28px 0 0',padding:'1.25rem 1.25rem 7rem',maxWidth:'480px',width:'100%',margin:'0 auto',boxShadow:'0 -8px 40px rgba(0,0,0,0.12)',maxHeight:'90vh',overflowY:'auto'}},
        r('div',{style:{width:'36px',height:'4px',borderRadius:'2px',background:C.border,margin:'0 auto 1.25rem'}}),
        !fabMode
          ?r('div',null,
            r('div',{style:{fontWeight:800,fontSize:'1.1rem',color:C.text,marginBottom:'0.35rem'}},'New Entry'),
            r('div',{style:{fontSize:'0.73rem',color:C.sub,marginBottom:'1.25rem'}},'Choose what to record'),
            r('div',{style:{display:'grid',gridTemplateColumns:'1fr 1fr 1fr',gap:'0.65rem'}},
              ...[{m:'income',emoji:'‚¨áÔ∏è',label:'Income',sub:'Money in',col:C.green,bg:C.greenBg},{m:'spending',emoji:'‚¨ÜÔ∏è',label:'Spending',sub:'Money out',col:C.red,bg:C.redBg},{m:'swap',emoji:'‚ÜîÔ∏è',label:'Transfer',sub:'Move funds',col:C.blue,bg:'#EFF6FF'}].map(({m,emoji,label,sub,col,bg})=>
                r('button',{key:m,onClick:()=>openFab(m),style:{display:'flex',flexDirection:'column',alignItems:'center',padding:'1.25rem 0.5rem',borderRadius:'18px',border:`1.5px solid ${col}30`,background:bg,cursor:'pointer',gap:'0.35rem'}},r('span',{style:{fontSize:'1.75rem'}},emoji),r('span',{style:{fontWeight:700,fontSize:'0.83rem',color:col}},label),r('span',{style:{fontSize:'0.62rem',color:C.sub}},sub))
              )
            )
          )
          :r('div',null,
            r('div',{style:{display:'flex',alignItems:'center',gap:'0.65rem',marginBottom:'1.1rem'}},
              r('button',{onClick:()=>setFabMode(null),style:{background:C.bg,border:`1px solid ${C.border}`,borderRadius:'10px',padding:'0.35rem 0.7rem',cursor:'pointer',fontSize:'0.8rem',color:C.sub}},'‚Üê Back'),
              r('span',{style:{fontWeight:700,fontSize:'0.95rem',color:fabMode==='income'?C.green:fabMode==='spending'?C.red:C.blue}},fabMode==='income'?'‚¨áÔ∏è Income':fabMode==='spending'?'‚¨ÜÔ∏è Spending':'‚ÜîÔ∏è Transfer')
            ),
            actH.length===0&&r('div',{style:{background:C.redBg,border:`1px solid ${C.red}30`,borderRadius:'12px',padding:'0.7rem',fontSize:'0.78rem',color:C.red,marginBottom:'0.85rem'}},'‚ö†Ô∏è No holders. Add one from ‚ò∞ first.'),
            r('div',{style:{display:'flex',flexDirection:'column',gap:'0.8rem'}},
              r('div',null,r(SL,null,'AMOUNT'),r(FI,{value:jAmt,onChange:ev=>setJAmt(ev.target.value),type:'number',min:'0',placeholder:'0.00',autoFocus:true,style:{fontSize:'1.35rem',fontWeight:800}})),
              fabMode==='income'&&r('div',null,r(SL,{req:true},'INCOME SOURCE'),r(FS,{value:jIncB,onChange:ev=>setJIncB(ev.target.value)},r('option',{value:''},'‚Äî Choose ‚Äî'),...actIncB.map(b=>r('option',{key:b.id,value:b.id},b.name)))),
              fabMode==='spending'&&r('div',null,r(SL,{req:true},'SPENDING CATEGORY'),r(FS,{value:jExpB,onChange:ev=>setJExpB(ev.target.value)},r('option',{value:''},'‚Äî Choose ‚Äî'),...actExpB.map(b=>r('option',{key:b.id,value:b.id},b.name)))),
              r('div',null,
                r(SL,{req:fabMode==='swap'||otherNeedsNote},fabMode==='swap'?'NOTE (required)':otherNeedsNote?'NOTE (required for "Other" ‚â• ‚Çπ1,000)':'NOTE (optional)'),
                r(FI,{value:jNote,onChange:ev=>setJNote(ev.target.value),placeholder:fabMode==='swap'?'e.g. Rent payment‚Ä¶':fabMode==='spending'?'e.g. Swiggy, petrol‚Ä¶':'e.g. Salary June‚Ä¶'})
              ),
              r('div',{style:{display:'grid',gridTemplateColumns:fabMode==='swap'?'1fr 1fr':'1fr',gap:'0.6rem'}},
                r('div',null,r(SL,null,fabMode==='swap'?'FROM':'HOLDER'),r(FS,{value:jFrom,onChange:ev=>setJFrom(ev.target.value)},r('option',{value:''},'Select'),...actH.map(x=>r('option',{key:x.id,value:x.id},`${x.name} (${fmt(x.balance)})`))),),
                fabMode==='swap'&&r('div',null,r(SL,null,'TO'),r(FS,{value:jTo,onChange:ev=>setJTo(ev.target.value)},r('option',{value:''},'Select'),...actH.filter(x=>x.id!==jFrom).map(x=>r('option',{key:x.id,value:x.id},x.name))))
              ),
              r('div',null,r(SL,null,'DATE'),r(FI,{type:'date',value:jDate,onChange:ev=>setJDate(ev.target.value)})),
              r('button',{onClick:submitTxn,style:{padding:'0.8rem',borderRadius:'14px',border:'none',background:fabMode==='income'?C.green:fabMode==='spending'?C.red:C.blue,color:'white',fontWeight:800,fontSize:'0.95rem',cursor:'pointer'}},`Record ${fabMode==='income'?'Income':fabMode==='spending'?'Spending':'Transfer'}`)
            )
          )
      )
    ),

    /* Sidebar */
    sidebar&&r('div',{style:{position:'fixed',inset:0,zIndex:200,display:'flex'}},
      r('div',{style:{position:'absolute',inset:0,background:'rgba(0,0,0,0.3)',backdropFilter:'blur(4px)'},onClick:()=>setSidebar(false)}),
      r('div',{style:{position:'relative',marginLeft:'auto',width:'300px',background:'white',height:'100%',overflowY:'auto',padding:'1.5rem 1.1rem',display:'flex',flexDirection:'column',gap:'0.4rem',boxShadow:'-4px 0 40px rgba(0,0,0,0.12)'}},
        r('div',{style:{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:'0.75rem'}},r('span',{style:{fontFamily:'cursive',fontSize:'1.5rem',color:C.accent}},'Jimikki'),r('button',{onClick:()=>setSidebar(false),style:{background:C.bg,border:`1px solid ${C.border}`,borderRadius:'8px',padding:'0.3rem 0.6rem',cursor:'pointer',color:C.sub}},'‚úï')),
        userEmail&&r('div',{style:{display:'flex',alignItems:'center',justifyContent:'space-between',background:C.accentBg,borderRadius:'12px',padding:'0.5rem 0.75rem',marginBottom:'0.25rem'}},
          r('div',null,
            r('div',{style:{fontSize:'0.58rem',fontWeight:700,color:C.muted,letterSpacing:'0.08em'}},'SIGNED IN AS'),
            r('div',{style:{fontSize:'0.72rem',fontWeight:600,color:C.accent,overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap',maxWidth:'160px'}},userEmail)
          ),
          r('a',{href:'/cdn-cgi/access/logout',style:{fontSize:'0.65rem',color:C.red,fontWeight:700,textDecoration:'none',background:C.redBg,padding:'3px 8px',borderRadius:'6px'}},'Sign out')
        ),
        ...[['home','üè† Home'],['analytics','üìä Analytics']].map(([v,l])=>r('button',{key:v,onClick:()=>{setView(v);setSidebar(false);},style:{textAlign:'left',padding:'0.6rem 0.85rem',border:`1px solid ${view===v?C.accent+'60':C.border}`,borderRadius:'12px',background:view===v?C.accentBg:'transparent',fontWeight:view===v?700:400,cursor:'pointer',fontSize:'0.88rem',color:view===v?C.accent:C.sub}},l)),
        r('div',{style:{height:'1px',background:C.border,margin:'0.5rem 0'}}),
        r('div',{style:{fontSize:'0.6rem',fontWeight:700,color:C.muted,letterSpacing:'0.1em'}},'MONEY HOLDERS'),
        actH.length===0&&r('div',{style:{fontSize:'0.78rem',color:C.muted,textAlign:'center',padding:'0.65rem'}},'No holders yet'),
        ...actH.map(x=>r('div',{key:x.id,style:{display:'flex',alignItems:'center',gap:'0.45rem',padding:'0.5rem 0.7rem',background:C.bg,borderRadius:'12px',border:`1px solid ${C.border}`}},
          r('div',{style:{width:'8px',height:'8px',borderRadius:'50%',background:x.isPrimary?C.accent:C.muted,flexShrink:0}}),
          r('div',{style:{flex:1,minWidth:0}},r('div',{style:{fontSize:'0.82rem',fontWeight:600,color:C.text,overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap'}},x.name),r('div',{style:{fontSize:'0.68rem',color:C.sub}},fmt(x.balance))),
          !x.isPrimary&&r('button',{onClick:()=>setPrimary(x.id),style:{background:'none',border:`1px solid ${C.border}`,borderRadius:'6px',padding:'2px 6px',cursor:'pointer',color:C.muted,fontSize:'0.62rem'}},'‚òÖ'),
          /* Delete button: grey/locked icon if balance > 0, red √ó if zero */
          !x.isPrimary&&r('button',{
            onClick:()=>tryDelHolder(x.id),
            title:x.balance>0?'Clear balance to ‚Çπ0 before deleting':'Archive holder',
            style:{background:'none',border:'none',cursor:x.balance>0?'not-allowed':'pointer',color:x.balance>0?C.muted:C.red,fontSize:'1rem',opacity:x.balance>0?0.4:0.75}
          },x.balance>0?'üîí':'√ó')
        )),
        r('div',{style:{display:'flex',gap:'0.35rem'}},r(FI,{value:nhName,onChange:ev=>setNhName(ev.target.value),onKeyDown:ev=>ev.key==='Enter'&&addHolder(),placeholder:'Name',style:{flex:2,minWidth:0}}),r(FI,{value:nhBal,onChange:ev=>setNhBal(ev.target.value),onKeyDown:ev=>ev.key==='Enter'&&addHolder(),placeholder:'‚Çπ',type:'number',min:'0',style:{flex:1,minWidth:0}}),r('button',{onClick:addHolder,style:{background:C.accent,color:'white',border:'none',borderRadius:'12px',padding:'0.5rem 0.75rem',cursor:'pointer',fontWeight:700,fontSize:'1rem',flexShrink:0}},'+')
        ),
        delH.length>0&&r('div',null,r('div',{style:{fontSize:'0.6rem',fontWeight:700,color:C.muted,marginTop:'0.25rem'}},'ARCHIVED'),...delH.map(x=>r('div',{key:x.id,style:{display:'flex',alignItems:'center',gap:'0.4rem',padding:'0.45rem 0.7rem',background:'#FFFBEB',borderRadius:'10px',border:'1px solid #FDE68A'}},r('div',{style:{flex:1,fontSize:'0.78rem',color:'#92400E',overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap'}},`${x.name} (${fmt(x.balance)})`),r('button',{onClick:()=>restHolder(x.id),style:{fontSize:'0.68rem',background:'#FEF3C7',color:'#92400E',border:'1px solid #FDE68A',borderRadius:'6px',padding:'2px 8px',cursor:'pointer'}},'‚Ü©')))),
        r('div',{style:{height:'1px',background:C.border,margin:'0.5rem 0'}}),
        r('div',{style:{fontSize:'0.6rem',fontWeight:700,color:C.muted}},'üí∏ EXPENSE BUCKETS'),
        r('div',{style:{fontSize:'0.62rem',color:C.muted,marginBottom:'4px'}},'Removing keeps past transactions intact.'),
        ...actExpB.map(b=>r('div',{key:b.id,style:{display:'flex',alignItems:'center',gap:'0.5rem',padding:'0.45rem 0.7rem',background:C.bg,borderRadius:'10px',border:`1px solid ${C.border}`}},r('div',{style:{width:'9px',height:'9px',borderRadius:'3px',background:b.color,flexShrink:0}}),r('span',{style:{flex:1,fontSize:'0.8rem',fontWeight:500,color:C.text,overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap'}},b.name+(b.fixed?' üîí':'')),!b.fixed&&r('button',{onClick:()=>delExpB(b.id),style:{background:'none',border:'none',cursor:'pointer',color:C.red,fontSize:'1rem',opacity:0.7,lineHeight:1,padding:'0 2px'}},'√ó'))),
        r('div',{style:{display:'flex',gap:'0.35rem',alignItems:'center',marginBottom:'0.25rem'}},r(FI,{value:nbExpName,onChange:ev=>setNbExpName(ev.target.value),onKeyDown:ev=>ev.key==='Enter'&&addExpB(),placeholder:'New expense bucket',style:{flex:1,minWidth:0}}),r('div',{style:{display:'flex',gap:'3px'}},...PALETTE.slice(0,4).map(c=>r('button',{key:c,onClick:()=>setNbExpColor(c),style:{width:'18px',height:'18px',borderRadius:'4px',background:c,border:nbExpColor===c?'2px solid #1A1D2E':'2px solid transparent',cursor:'pointer'}}))),r('button',{onClick:addExpB,style:{background:C.red,color:'white',border:'none',borderRadius:'10px',padding:'0.45rem 0.65rem',cursor:'pointer',fontWeight:700}},'+')
        ),
        r('div',{style:{height:'1px',background:C.border,margin:'0.5rem 0'}}),
        r('div',{style:{fontSize:'0.6rem',fontWeight:700,color:C.muted}},'üí∞ INCOME BUCKETS'),
        r('div',{style:{fontSize:'0.62rem',color:C.muted,marginBottom:'4px'}},'Removing keeps past transactions intact.'),
        ...actIncB.map(b=>r('div',{key:b.id,style:{display:'flex',alignItems:'center',gap:'0.5rem',padding:'0.45rem 0.7rem',background:C.bg,borderRadius:'10px',border:`1px solid ${C.border}`}},r('div',{style:{width:'9px',height:'9px',borderRadius:'3px',background:b.color,flexShrink:0}}),r('span',{style:{flex:1,fontSize:'0.8rem',fontWeight:500,color:C.text,overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap'}},b.name+(b.fixed?' üîí':'')),!b.fixed&&r('button',{onClick:()=>delIncB(b.id),style:{background:'none',border:'none',cursor:'pointer',color:C.red,fontSize:'1rem',opacity:0.7,lineHeight:1,padding:'0 2px'}},'√ó'))),
        r('div',{style:{display:'flex',gap:'0.35rem',alignItems:'center'}},r(FI,{value:nbIncName,onChange:ev=>setNbIncName(ev.target.value),onKeyDown:ev=>ev.key==='Enter'&&addIncB(),placeholder:'New income bucket',style:{flex:1,minWidth:0}}),r('div',{style:{display:'flex',gap:'3px'}},...PALETTE.slice(0,4).map(c=>r('button',{key:c,onClick:()=>setNbIncColor(c),style:{width:'18px',height:'18px',borderRadius:'4px',background:c,border:nbIncColor===c?'2px solid #1A1D2E':'2px solid transparent',cursor:'pointer'}}))),r('button',{onClick:addIncB,style:{background:C.green,color:'white',border:'none',borderRadius:'10px',padding:'0.45rem 0.65rem',cursor:'pointer',fontWeight:700}},'+'))
      )
    ),

    /* Header */
    r('header',{style:{position:'sticky',top:0,zIndex:100,background:'rgba(244,246,251,0.9)',backdropFilter:'blur(14px)',borderBottom:`1px solid ${C.border}`,padding:'0.85rem 1.1rem',display:'flex',justifyContent:'space-between',alignItems:'center'}},
      r('span',{style:{fontFamily:'cursive',fontSize:'1.7rem',color:C.accent}},'Jimikki'),
      r('button',{onClick:()=>setSidebar(true),style:{background:'white',border:`1px solid ${C.border}`,borderRadius:'10px',padding:'0.45rem 0.7rem',cursor:'pointer',display:'flex',flexDirection:'column',gap:'4px',boxShadow:'0 1px 4px rgba(0,0,0,0.06)'}},...[0,1,2].map(i=>r('span',{key:i,style:{display:'block',width:'18px',height:'2px',background:C.sub,borderRadius:'1px'}})))
    ),

    r('main',{style:{padding:'1rem',paddingBottom:'7rem',display:'flex',flexDirection:'column',gap:'1rem'}},

      /* ‚ïê‚ïê‚ïê HOME ‚ïê‚ïê‚ïê */
      view==='home'&&r('div',{style:{display:'flex',flexDirection:'column',gap:'1rem'}},
        r('div',{style:{background:'linear-gradient(135deg,#4338CA 0%,#6366F1 60%,#818CF8 100%)',borderRadius:'24px',padding:'1.75rem 1.5rem',position:'relative',overflow:'hidden',boxShadow:'0 8px 32px rgba(79,70,229,0.3)'}},
          r('div',{style:{position:'absolute',top:'-30px',right:'-20px',width:'130px',height:'130px',borderRadius:'50%',background:'rgba(255,255,255,0.08)'}}),
          r('div',{style:{position:'absolute',bottom:'-40px',left:'10px',width:'90px',height:'90px',borderRadius:'50%',background:'rgba(255,255,255,0.05)'}}),
          r('div',{style:{position:'relative'}},
            r('div',{style:{display:'flex',justifyContent:'space-between',alignItems:'flex-start',gap:'0.5rem',flexWrap:'wrap'}},
              r('div',null,r('div',{style:{fontSize:'0.58rem',fontWeight:700,color:'rgba(255,255,255,0.5)',letterSpacing:'0.12em',marginBottom:'4px'}},'CONSOLIDATED WEALTH'),r('div',{style:{fontSize:'2.4rem',fontWeight:800,color:'white',letterSpacing:'-2px',lineHeight:1.1}},fmt(wealth(hHFilter)))),
              r('button',{onClick:()=>setHFilterOpen(true),style:{display:'flex',alignItems:'center',gap:'5px',padding:'5px 10px',borderRadius:'999px',background:'rgba(255,255,255,0.2)',border:'1px solid rgba(255,255,255,0.3)',color:'white',cursor:'pointer',fontSize:'0.68rem',fontWeight:700,whiteSpace:'nowrap'}},'üóì ',filterLabel(hFilter))
            ),
            r('div',{style:{display:'flex',gap:'1.5rem',marginTop:'1.1rem'}},
              r('div',null,r('div',{style:{fontSize:'0.58rem',color:'rgba(255,255,255,0.45)',letterSpacing:'0.08em'}},'IN'),r('div',{style:{fontSize:'1rem',fontWeight:700,color:'#A7F3D0'}},fmt(hStats.inc))),
              r('div',{style:{width:'1px',background:'rgba(255,255,255,0.15)'}}),
              r('div',null,r('div',{style:{fontSize:'0.58rem',color:'rgba(255,255,255,0.45)',letterSpacing:'0.08em'}},'OUT'),r('div',{style:{fontSize:'1rem',fontWeight:700,color:'#FCA5A5'}},fmt(hStats.spd))),
              r('div',{style:{width:'1px',background:'rgba(255,255,255,0.15)'}}),
              r('div',null,r('div',{style:{fontSize:'0.58rem',color:'rgba(255,255,255,0.45)',letterSpacing:'0.08em'}},'NET'),r('div',{style:{fontSize:'1rem',fontWeight:700,color:'white'}},fmt(hStats.net)))
            )
          )
        ),
        actH.length>0&&r('div',{style:{display:'flex',gap:'6px',flexWrap:'wrap'}},
          ...[{id:null,name:'All'},...actH].map(x=>r('button',{key:x.id||'all',onClick:()=>setHHFilter(x.id===null?null:(hHFilter===x.id?null:x.id)),style:{padding:'4px 12px',borderRadius:'999px',border:`1px solid ${(x.id===null?!hHFilter:hHFilter===x.id)?C.accent:C.border}`,background:(x.id===null?!hHFilter:hHFilter===x.id)?C.accentBg:'white',color:(x.id===null?!hHFilter:hHFilter===x.id)?C.accent:C.sub,cursor:'pointer',fontSize:'0.72rem',fontWeight:(x.id===null?!hHFilter:hHFilter===x.id)?700:400}},x.name))
        ),
        r(Card,null,
          r('div',{style:{display:'flex',justifyContent:'space-between',alignItems:'flex-start',marginBottom:'0.85rem',flexWrap:'wrap',gap:'0.5rem'}},
            r('div',null,r('div',{style:{fontWeight:700,fontSize:'0.88rem',color:C.text}},'Total Account Balance'),r('div',{style:{fontSize:'0.65rem',color:C.sub,marginTop:'2px'}},'Tap a dot ‚Üí balance ¬∑ ‚ú¶ Explore in Analytics')),
            r(GranPills,{value:hGran,onChange:setHGran})
          ),
          r(BalanceAreaChart,{data:hBalData,height:200,onExplore:handleExplore})
        ),
        /* ‚îÄ‚îÄ Holdings card (renamed from "Your Holders") ‚îÄ‚îÄ */
        actH.length>0
          ?r(Card,null,r('div',{style:{fontWeight:700,fontSize:'0.88rem',color:C.text,marginBottom:'0.85rem'}},'Your Holdings'),
            ...actH.map((x,i)=>r('div',{key:x.id,style:{display:'flex',justifyContent:'space-between',alignItems:'center',padding:'0.65rem 0',borderBottom:i<actH.length-1?`1px solid ${C.border}`:'none'}},
              r('div',{style:{display:'flex',alignItems:'center',gap:'0.75rem'}},r('div',{style:{width:'38px',height:'38px',borderRadius:'12px',background:x.isPrimary?C.accentBg:C.bg,border:`1.5px solid ${x.isPrimary?C.accent:C.border}`,display:'flex',alignItems:'center',justifyContent:'center',fontWeight:800,fontSize:'0.92rem',color:x.isPrimary?C.accent:C.sub}},x.name.charAt(0).toUpperCase()),r('div',null,r('div',{style:{fontWeight:600,fontSize:'0.88rem',color:C.text}},x.name),x.isPrimary&&r('div',{style:{fontSize:'0.6rem',color:C.accent,marginTop:'1px'}},'Primary'))),
              r('div',{style:{fontWeight:800,fontSize:'0.98rem',color:C.text}},fmt(x.balance))
            ))
          )
          :r('div',{style:{background:'white',borderRadius:'20px',padding:'2.5rem 1.5rem',textAlign:'center',border:`1.5px dashed ${C.border}`}},r('div',{style:{fontSize:'2rem',marginBottom:'0.75rem'}},'üí≥'),r('div',{style:{fontWeight:700,color:C.text,marginBottom:'0.4rem'}},'No holdings yet'),r('div',{style:{fontSize:'0.78rem',color:C.sub}},'Open ‚ò∞ to add your first money holder'))
      ),

      /* ‚ïê‚ïê‚ïê ANALYTICS ‚ïê‚ïê‚ïê */
      view==='analytics'&&r('div',{style:{display:'flex',flexDirection:'column',gap:'1rem'}},
        r('div',{style:{display:'flex',justifyContent:'space-between',alignItems:'flex-start',gap:'0.5rem'}},
          r('div',null,
            r('div',{style:{fontWeight:700,fontSize:'0.95rem',color:C.text}},'Analytics'),
            r('div',{style:{fontSize:'0.65rem',color:C.sub,marginTop:'2px'}},aBadge())
          ),
          r('button',{onClick:()=>setAFilterOpen(true),style:{display:'flex',alignItems:'center',gap:'6px',padding:'8px 14px',borderRadius:'12px',border:`1.5px solid ${aActiveCount>0?C.accent:C.border}`,background:aActiveCount>0?C.accentBg:'white',color:aActiveCount>0?C.accent:C.sub,cursor:'pointer',fontWeight:700,fontSize:'0.78rem',whiteSpace:'nowrap',flexShrink:0}},
            '‚öôÔ∏è Filter',aActiveCount>0&&r('span',{style:{background:C.accent,color:'white',borderRadius:'999px',padding:'1px 7px',fontSize:'0.65rem',fontWeight:800}},aActiveCount)
          )
        ),
        r('div',{style:{display:'grid',gridTemplateColumns:'1fr 1fr 1fr',gap:'0.5rem'}},
          ...[{l:'INCOME',v:fmt(aStats.inc),col:C.green},{l:'SPENDING',v:fmt(aStats.spd),col:C.red},{l:'NET',v:fmt(aStats.net),col:C.accent}].map(({l,v,col})=>
            r('div',{key:l,style:{background:'white',borderRadius:'16px',padding:'0.85rem 0.5rem',border:`1px solid ${C.border}`,textAlign:'center',boxShadow:'0 2px 8px rgba(0,0,0,0.04)'}},r('div',{style:{fontSize:'0.55rem',fontWeight:700,color:C.muted,letterSpacing:'0.1em',marginBottom:'4px'}},l),r('div',{style:{fontSize:'0.78rem',fontWeight:800,color:col}},v))
          )
        ),
        r('div',{style:{display:'flex',background:'white',borderRadius:'14px',padding:'4px',border:`1px solid ${C.border}`}},
          ...[['flow','üìà Net Flow'],['buckets','ü™£ Buckets'],['txns','üìã Transactions']].map(([v,l])=>r('button',{key:v,onClick:()=>setAView(v),style:{flex:1,padding:'0.45rem 0.25rem',borderRadius:'10px',border:'none',background:aView===v?C.accent:'transparent',color:aView===v?'white':C.sub,cursor:'pointer',fontWeight:700,fontSize:'0.72rem'}},l))
        ),
        aView==='flow'&&r(Card,null,
          r('div',{style:{fontWeight:700,fontSize:'0.88rem',color:C.text,marginBottom:'3px'}},'Net Savings ‚Äî '+filterLabel(aFilter)),
          r('div',{style:{fontSize:'0.65rem',color:C.sub,marginBottom:'0.85rem'}},'Last 12 months ¬∑ tap a bar to see breakdown'),
          aStats.inc===0&&aStats.spd===0
            ?r('div',{style:{textAlign:'center',padding:'2rem',color:C.muted,fontSize:'0.82rem'}},'No transactions for this period')
            :r(NetBarChart,{data:buildNetData(actT.filter(t=>!aHFilter||t.holderId===aHFilter),aHFilter),height:190})
        ),
        aView==='buckets'&&r('div',{style:{display:'flex',flexDirection:'column',gap:'1rem'}},
          r(Card,null,
            r('div',{style:{display:'flex',alignItems:'center',gap:'8px',marginBottom:'1rem'}},r('div',{style:{width:'10px',height:'10px',borderRadius:'50%',background:C.green}}),r('div',{style:{fontWeight:700,fontSize:'0.88rem',color:C.text}},'Income by Source')),
            incStats.length===0
              ?r('div',{style:{textAlign:'center',padding:'1.5rem',color:C.muted,fontSize:'0.8rem'}},'No income data for this period')
              :r('div',null,r('div',{style:{display:'flex',justifyContent:'center',marginBottom:'1.1rem'}},r(DonutChart,{data:incStats.map(b=>({...b,id:b.id}))})),...incStats.map(b=>r(BucketRow,{key:b.id,b,total:b.total,grand:incTotal})))
          ),
          r(Card,null,
            r('div',{style:{display:'flex',alignItems:'center',gap:'8px',marginBottom:'1rem'}},r('div',{style:{width:'10px',height:'10px',borderRadius:'50%',background:C.red}}),r('div',{style:{fontWeight:700,fontSize:'0.88rem',color:C.text}},'Spending by Category')),
            expStats.length===0
              ?r('div',{style:{textAlign:'center',padding:'1.5rem',color:C.muted,fontSize:'0.8rem'}},'No spending data for this period')
              :r('div',null,r('div',{style:{display:'flex',justifyContent:'center',marginBottom:'1.1rem'}},r(DonutChart,{data:expStats.map(b=>({...b,id:b.id}))})),...expStats.map(b=>r(BucketRow,{key:b.id,b,total:b.total,grand:expTotal})))
          )
        ),
        aView==='txns'&&r(Card,null,
          r('div',{style:{fontWeight:700,fontSize:'0.88rem',color:C.text,marginBottom:'0.75rem'}},'Transactions ',r('span',{style:{fontWeight:400,color:C.muted,fontSize:'0.72rem'}},`(${aFilteredT.length})`)),
          aFilteredT.length===0
            ?r('div',{style:{color:C.muted,fontSize:'0.82rem',textAlign:'center',padding:'2rem 0'}},'No transactions for this period')
            :aFilteredT.map(t=>r(TxnRow,{key:t.id,t,onDel:()=>setPendingDelId(t.id)})),
          delT.length>0&&r('div',{style:{marginTop:'1.25rem'}},
            r('div',{style:{display:'flex',alignItems:'center',gap:'6px',marginBottom:'0.6rem'}},r('span',{style:{fontSize:'1rem'}},'üóëÔ∏è'),r('span',{style:{fontWeight:700,fontSize:'0.82rem',color:C.text}},'Recycle Bin'),r('span',{style:{fontWeight:400,color:C.muted,fontSize:'0.72rem'}},`(${delT.length})`)),
            r('div',{style:{background:'#FFFBEB',borderRadius:'14px',padding:'0.75rem 0.85rem',border:'1px solid #FDE68A'}},...delT.map(t=>r(TxnRow,{key:t.id,t,onRest:()=>restTxn(t.id)})))
          )
        )
      )
    ),

    /* Bottom Nav */
    r('nav',{style:{position:'fixed',bottom:0,left:'50%',transform:'translateX(-50%)',width:'100%',maxWidth:'480px',background:'rgba(255,255,255,0.95)',backdropFilter:'blur(16px)',borderTop:`1px solid ${C.border}`,display:'flex',alignItems:'center',zIndex:90,height:'64px',boxShadow:'0 -2px 16px rgba(0,0,0,0.06)'}},
      r('button',{onClick:()=>setView('home'),style:{flex:1,height:'100%',background:'none',border:'none',cursor:'pointer',display:'flex',flexDirection:'column',alignItems:'center',justifyContent:'center',gap:'2px',color:view==='home'?C.accent:C.muted}},r('span',{style:{fontSize:'1.1rem'}},'üè†'),r('span',{style:{fontSize:'0.6rem',fontWeight:view==='home'?700:400}},'Home')),
      r('div',{style:{flex:'0 0 80px',display:'flex',justifyContent:'center',alignItems:'center'}},
        r('button',{onClick:()=>{setFabOpen(true);setFabMode(null);},style:{width:'52px',height:'52px',borderRadius:'16px',background:C.accent,border:'none',cursor:'pointer',display:'flex',alignItems:'center',justifyContent:'center',boxShadow:'0 6px 20px rgba(79,70,229,0.4)',transform:'translateY(-10px)',color:'white',flexShrink:0}},
          r('svg',{width:24,height:24,viewBox:'0 0 24 24',fill:'none',stroke:'currentColor',strokeWidth:'2.5',strokeLinecap:'round'},r('line',{x1:12,y1:5,x2:12,y2:19}),r('line',{x1:5,y1:12,x2:19,y2:12}))
        )
      ),
      r('button',{onClick:()=>setView('analytics'),style:{flex:1,height:'100%',background:'none',border:'none',cursor:'pointer',display:'flex',flexDirection:'column',alignItems:'center',justifyContent:'center',gap:'2px',color:view==='analytics'?C.accent:C.muted}},r('span',{style:{fontSize:'1.1rem'}},'üìä'),r('span',{style:{fontSize:'0.6rem',fontWeight:view==='analytics'?700:400}},'Analytics'))
    )
  );
}

ReactDOM.createRoot(document.getElementById('root')).render(React.createElement(Jimikki));
</script>
</body>
</html>
